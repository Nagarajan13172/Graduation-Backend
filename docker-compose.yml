services:
  graduate-backend:
    image: graduate-backend
    container_name: graduate-backend
    hostname: graduate
    restart: always
    env_file:
      - .env
    healthcheck:
      test: [ "CMD-SHELL", "curl -fsS http://localhost:3000/ || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    networks:
      - app
      - edge
    labels:
      - traefik.enable=true
      - traefik.http.routers.api.rule=Host(`graduate.periyaruniversity.ac.in`) && PathPrefix(`/api`)
      - traefik.http.routers.api.entrypoints=websecure
      - traefik.http.routers.api.tls=true
      - traefik.http.routers.api.tls.certresolver=myresolver
      - traefik.http.services.api.loadbalancer.server.port=3000
      # CORS / headers (optional if same origin)
      - traefik.http.middlewares.api-headers.headers.accesscontrolallowmethods=GET,POST,PUT,PATCH,DELETE,OPTIONS
      - traefik.http.middlewares.api-headers.headers.accesscontrolallowheaders=Content-Type,Authorization
      - traefik.http.middlewares.api-headers.headers.accesscontrolalloworiginlist=https://graduate.periyaruniversity.ac.in
      - traefik.http.middlewares.api-headers.headers.accesscontrolallowcredentials=true
      - traefik.http.routers.api.middlewares=api-headers,ratelimit
      - traefik.http.middlewares.ratelimit.ratelimit.average=30
      - traefik.http.middlewares.ratelimit.ratelimit.burst=120
      - traefik.http.middlewares.ratelimit.ratelimit.period=3s
      - traefik.http.middlewares.ratelimit.ratelimit.sourceCriterion.ipStrategy.depth=1

    volumes:
      - graduate_uploads:/home/periyaruniversity/Faculty-Backend/src/Uploads
      - data_volume:/home/periyaruniversity/Faculty-Backend/data
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 512M

volumes:
  graduate_uploads:
    driver: local
  data_volume:
    driver: local

networks:
  edge:
    external: true
    name: edge
  app:
    external: true
    name: app
